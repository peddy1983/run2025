# LINE 手動推播功能說明

> 📅 新增日期：2025-11-24  
> 🎯 功能：活動卡片增加 LINE 推播按鈕  
> 💡 目的：解決自動推播不穩定的問題

---

## ✨ 新增功能

### 📢 手動 LINE 推播按鈕

在「我的活動」→「我發起的」頁面，每個活動卡片上新增了「📢 LINE通知」按鈕，讓您可以**手動推播活動到 LINE 群組**。

---

## 🎯 功能特色

### 1. 只對建立者顯示
- ✅ 只有**活動建立者**才能看到推播按鈕
- ✅ 其他參加者看不到此按鈕
- ✅ 避免重複推播

### 2. 即時推播
- 點擊按鈕後立即發送到 LINE 群組
- 不需要等待排程時間
- 可以多次推播同一個活動

### 3. 確認機制
- 點擊按鈕會跳出確認對話框
- 避免誤觸

### 4. 狀態提示
- 推播中：顯示「⏳ 推播中...」
- 成功：顯示「✅ LINE 通知已發送！」
- 失敗：顯示錯誤訊息

---

## 📍 使用位置

### 路徑：我的活動 → 我發起的

```
首頁
└── 我的活動（點擊導覽列的「我的活動」）
    └── 我發起的（分頁）
        └── 活動卡片
            └── 📢 LINE通知 按鈕
```

---

## 🚀 使用方法

### 步驟 1：進入「我的活動」
1. 點擊頂部導覽列的 **「我的活動」**
2. 確認在 **「我發起的」** 分頁

### 步驟 2：找到要推播的活動
- 在活動列表中找到想要推播的活動
- 每個活動卡片右下角都有 **「📢 LINE通知」** 按鈕

### 步驟 3：點擊推播按鈕
1. 點擊 **「📢 LINE通知」** 按鈕
2. 確認對話框會出現：「確定要推播此活動到 LINE 群組嗎？」
3. 點擊 **「確定」**

### 步驟 4：等待推播完成
- 按鈕顯示 **「⏳ 推播中...」**
- 稍等 1-2 秒
- 成功後顯示 **「✅ LINE 通知已發送！」**

### 步驟 5：檢查 LINE 群組
- 前往 LINE 群組確認
- 應該會收到活動通知訊息

---

## 💬 推播訊息格式

```
🏃‍♂️ 新活動通知 #123

📅 日期時間：11/24(日) 06:00
⏱️ 目標配速：5:30
📏 目標距離：10K
🗺️ 路線規劃：河濱公園
📝 其他提醒：記得帶水

👤 主揪人：王小明

🔗 立即報名：https://banqiaorun2025.netlify.app/
```

---

## 🎨 按鈕樣式

### 外觀
- 🎨 綠色背景（#10B981）
- 📱 圓角設計
- 📢 圖示 + 文字

### 狀態變化

| 狀態 | 顯示內容 | 顏色 |
|-----|---------|------|
| 正常 | 📢 LINE通知 | 綠色 |
| 推播中 | ⏳ 推播中... | 綠色（半透明）|
| 禁用 | 📢 LINE通知 | 灰色 |

---

## 🔧 技術實作

### 前端變更

#### 1. ActivityCard 組件 (`src/components/ActivityCard.jsx`)

**新增 Props**：
```javascript
showLineNotify={true}  // 是否顯示 LINE 推播按鈕
```

**新增狀態**：
```javascript
const [notifying, setNotifying] = useState(false);  // 推播中狀態
```

**新增函數**：
```javascript
const handleLineNotify = async () => {
  // 發送 LINE 通知的邏輯
}
```

**新增按鈕**：
```javascript
{showLineNotify && isCreator && (
  <button onClick={handleLineNotify}>
    📢 LINE通知
  </button>
)}
```

#### 2. MyActivities 頁面 (`src/pages/MyActivities.jsx`)

**傳入 Props**：
```javascript
<ActivityCard 
  activity={activity} 
  showLineNotify={true}  // 啟用 LINE 推播按鈕
/>
```

### 後端 Function

使用現有的 `netlify/functions/send-line-notification.js`
- 接收活動資料
- 格式化訊息
- 發送到 LINE 群組

---

## ⚠️ 注意事項

### 1. 權限限制
- ✅ 只有活動建立者可以推播
- ❌ 參加者無法推播

### 2. 推播次數
- ✅ 可以多次推播同一個活動
- ⚠️ 每次推播都會計入 LINE 訊息額度
- 💡 建議：避免短時間內重複推播

### 3. 環境變數
確保以下環境變數已設定：
- `LINE_MESSAGING_CHANNEL_ACCESS_TOKEN`
- `LINE_GROUP_ID`

### 4. 網路狀態
- 需要網路連線
- 推播失敗時會顯示錯誤訊息

---

## 🆚 與自動推播的比較

| 項目 | 自動推播 | 手動推播 |
|-----|---------|---------|
| 觸發時機 | 建立活動時自動 | 點擊按鈕手動 |
| 推播時間 | 立即 | 隨時可推播 |
| 推播次數 | 只有一次 | 可多次 |
| 適用情境 | 新活動通知 | 補發通知、再次提醒 |
| 穩定性 | 依賴系統 | 即時控制 |

---

## 💡 使用場景

### 場景 1：自動推播失敗
```
情況：建立活動時自動推播失敗
解決：使用手動推播補發通知
```

### 場景 2：重要活動再次提醒
```
情況：明天有重要活動，想再提醒一次
解決：點擊手動推播再發送一次
```

### 場景 3：修改活動後通知
```
情況：活動時間或地點有變更
解決：編輯活動後，手動推播更新通知
```

### 場景 4：測試推播功能
```
情況：想測試 LINE 推播是否正常
解決：建立測試活動，使用手動推播測試
```

---

## 🔍 故障排除

### 問題 1：看不到「LINE通知」按鈕

**可能原因**：
- 不是活動建立者
- 不在「我發起的」分頁

**解決方法**：
1. 確認是否在「我的活動」→「我發起的」頁面
2. 確認是否為活動建立者

### 問題 2：點擊後沒有反應

**可能原因**：
- 網路連線問題
- 環境變數未設定

**解決方法**：
1. 檢查網路連線
2. 查看瀏覽器 Console 是否有錯誤訊息
3. 確認 Netlify 環境變數設定正確

### 問題 3：推播失敗

**可能原因**：
- LINE API Token 錯誤
- LINE Group ID 錯誤
- 機器人未加入群組

**解決方法**：
1. 確認機器人已加入 LINE 群組
2. 檢查 Netlify 環境變數
3. 查看 Netlify Function Logs

### 問題 4：推播成功但 LINE 沒收到

**可能原因**：
- GROUP_ID 設定錯誤
- 機器人被移除群組

**解決方法**：
1. 檢查 LINE_GROUP_ID 是否正確
2. 確認機器人仍在群組中
3. 測試發送新成員歡迎訊息確認連線正常

---

## 📊 費用計算

### LINE API 用量

每次手動推播 = **1 則訊息**

### 使用建議

```
每月建立 20 個活動：
- 自動推播（建立時）：20 則
- 手動補推（失敗時）：約 2-3 則
- 再次提醒：約 3-5 則
────────────────────────
總計：約 25-28 則/月 ✅ 免費範圍
```

### 避免浪費額度

- ✅ 只在必要時手動推播
- ✅ 避免短時間內重複推播
- ❌ 不要拿來測試（建議用測試群組）

---

## 🎯 最佳實踐

### 1. 何時使用手動推播

✅ **建議使用**：
- 自動推播失敗時
- 重要活動需要再次提醒
- 活動有重大變更
- 臨時新增活動想立即通知

❌ **不建議使用**：
- 已經自動推播成功
- 短時間內重複推播
- 只是小修改（如文字調整）

### 2. 推播時機

**最佳時機**：
- 🌅 早上 7:00-8:00（上班前）
- 🌆 晚上 7:00-9:00（下班後）

**避免時段**：
- 🌙 深夜 11:00 後
- 🌅 清晨 6:00 前

### 3. 推播頻率

**建議**：
- 同一活動最多推播 2-3 次
- 間隔至少 6 小時以上

---

## 📚 相關文件

- [LINE_WELCOME_MESSAGE_SETUP.md](./LINE_WELCOME_MESSAGE_SETUP.md) - 新成員歡迎訊息設定
- [LINE_NOTIFICATION_SETUP.md](./LINE_NOTIFICATION_SETUP.md) - LINE 通知完整設定
- [CRON_JOB_SETUP.md](./CRON_JOB_SETUP.md) - 定時推播設定

---

## 📝 更新日誌

### v1.1.0 - 2025-11-24
- ✨ 新增手動 LINE 推播按鈕
- 🎨 優化按鈕樣式和狀態顯示
- 🔒 限制只有建立者可見
- ✅ 新增確認對話框

---

**有任何問題歡迎參考此文件！** 📖

